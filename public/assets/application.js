function updateTitle(e){document.title=e?e+" | Postr":"Postr"}var app=angular.module("postrApp",[]);app.controller("appController",["$http","$scope",function(e,t){var o=this;this.currentUser={},this.viewUser={},this.viewPost={},this.session={},this.post={},this.comment={},this.user={showNameError:!1,showPassError:!1,showPassConError:!1},this.addingComment=!1,this.clearout=!1,this.showPostCheck=!1,this.showMenu=function(){o.clearout=!0},this.hideMenu=function(){o.clearout=!1},this.setIndexControls=function(e){return new Promise(function(t){"user"==e?o.indexControls=[{controller:"users",id:o.viewUser.id,action:"recent_list",title:"Recent"},{controller:"users",id:o.viewUser.id,action:"top_posts",title:"Top Posts"},{controller:"users",id:o.viewUser.id,action:"top_comments",title:"Top Comments"}]:(o.indexControls=[{controller:"posts",action:"index",title:"Latest"},{controller:"posts",action:"daily",title:"Daily"},{controller:"posts",action:"weekly",title:"Weekly"}],o.signedIn&&o.indexControls.push({controller:"posts",action:"favorites",title:"Favorites"})),t(o.indexControls)})},this.loadIndexList=function(n){var s,i="/";"undefined"==typeof n.controller&&(n.controller="posts"),i+=n.controller,s="index",n.id&&(i=i+"/"+n.id),n.action&&(s=n.action,"index"!=s&&(i=i+"/"+n.action)),i+=".json",(o.indexView!=s||n.force)&&("users"==n.controller||"undefined"!=typeof o[s]&&!n.force?"users"==n.controller&&"undefined"==typeof o.viewUser[s]?e.get(i).success(function(e){"undefined"==typeof e.items?(o.viewUser[s]=e,o.indexItems=e):(o.viewUser[s]=e.items,o.indexItems=e.items)}):o.indexItems="users"==n.controller?o.viewUser[s]:o[s]:e.get(i).success(function(e){"undefined"==typeof e.items?(o[s]=e,o.indexItems=e):(o[s]=e.items,o.indexItems=e.items)}),o.indexView=s),t.$$phase||t.$apply()},this.showIndex=function(e){e||(e={}),updateTitle(),e.preserveState||history.pushState({},"index","/"),o.currentTab="index",o.showPostCheckButton(),o.setIndexControls("posts").then(function(t){t.findOrFirst("action",o.indexView).then(function(t){e.force&&(t.force=!0),o.loadIndexList(t),t.force=!1})})},this.showIndexItem=function(e){"undefined"!=typeof e.title?o.showPost(e).then(function(e){index=o.indexItems.findIndex("id",e.id),index&&(e.loaded=!0,o.indexItems[index]=e)}):o.showComment(e)},this.showPostCheckButton=function(){setTimeout(function(){o.showPostCheck=!0,t.$apply()},6e4)},this.loadNextPosts=function(){nextStart=o.index[0].id+1,e.get("/posts.json?start_post="+nextStart).success(function(e){e.length>0&&o.index.unshift(e)}),o.showPostCheck=!1,o.showPostCheckButton()},this.loadPrevPosts=function(){previousStart=o.index[o.index.length-1].id-1,e.get("/posts.json?end_post="+previousStart).success(function(e){o.index=o.index.concat(e),e.length<5&&(o.outtaPosts=!0),o.indexItems=o.index})},this.newPost=function(){"undefined"!=typeof o.post.id&&(o.post={}),o.currentTab="form",document.getElementById("post_title").focus()},this.editPost=function(e){"undefined"!=typeof o.post&&o.post.id!=e.id&&(o.post={id:e.id,title:e.title,content:e.content}),o.currentTab="form",document.getElementById("post_title").focus()},this.exitForm=function(){o.currentTab=-1!=location.href.indexOf("/posts/")?"show":"index"},this.savePost=function(){"undefined"==typeof o.post.id?e.post("posts.json",o.post).success(function(){o.post={},o.showIndex({force:!0})}).error(function(e,t){o.post.errors=e.errors,401==t&&o.signOut()}):e.put("/posts/"+o.post.id+".json",o.post).success(function(){o.viewPost=o.post,o.post={},o.currentTab="show"})},this.loadPost=function(t){return new Promise(function(n){"undefined"==typeof t.content||"undefined"==typeof t.karma?(viewPostExists="undefined"!=typeof o.viewPost.id,(!viewPostExists||viewPostExists&&o.viewPost.id!=t)&&("undefined"==typeof t.id&&(t={id:t}),o.viewPost={},e.get("/posts/"+t.id+".json").success(function(e){t=e,o.viewPost=e,n(t)}))):(o.viewPost=t,n(t))})},this.showPost=function(t){return new Promise(function(n){o.loadPost(t).then(function(){-1==location.href.indexOf("posts")&&history.pushState({post:o.viewPost.id},o.viewPost.title+" | Postr",location.href.split("#")[0]+"#/posts/"+o.viewPost.id+"/"+o.viewPost.title.convertToSlug()),"undefined"==typeof o.viewPost.comments&&e.get("/posts/"+o.viewPost.id+"/comments.json").success(function(e){e.length>0&&(o.viewPost.comments=e)}),o.signedIn&&"undefined"==typeof o.viewPost.postRelation&&e.get("/posts/"+o.viewPost.id+"/post_relation.json").success(function(e){o.viewPost.postRelation=e}).error(function(e,t){401==t&&o.signOut()}),updateTitle(o.viewPost.title),o.viewPost.loaded=!0,o.addingComment=!1,o.currentTab="show",o.viewPost.commentIndex="created_at",n(o.viewPost)})})},this.vote=function(t){(o.viewPost.postRelation.voted&&confirm("Remove vote?")||!o.viewPost.postRelation.voted)&&e.head("/posts/"+t.id+"/vote").success(function(){console.log(o.viewPost.postRelation.voted),o.viewPost.postRelation.voted=!o.viewPost.postRelation.voted,console.log(o.viewPost.postRelation.voted),o.viewPost.karma+=o.viewPost.postRelation.voted?1:-1}).error(function(e,t){304==t&&alert("Post already voted on."),401==t&&o.signOut()})},this.favorite=function(){e.head("/posts/"+o.viewPost.id+"/favorite.json").success(function(){o.viewPost.postRelation.favorited=!o.viewPost.postRelation.favorited,"undefined"==typeof o.favorites&&(o.favorites=[]),(index=o.favorites.findIndex("id",o.viewPost.id))?o.favorites.splice(index,1):o.favorites.unshift(o.viewPost)}).error(function(e,t){304==t&&alert("Operation could not be performed."),401==t&&o.signOut(),404==t&&alert("Operation could not be performed.")})},this.saveComment=function(){o.comment.post_id=o.viewPost.id,e.post("/comments.json",o.comment).success(function(e){"undefined"!=typeof o.viewPost.comments?o.viewPost.comments.unshift(e):o.viewPost.comments=[e],o.viewPost.postRelation.comment_count=e.content.length,o.addingComment=!1,o.comment={}}).error(function(e,t){401==t&&o.signOut()})},this.showComment=function(e){o.showPost(e.post_id).then(function(){o.viewPost.featuredComment=e})},this.sortCommentsBy=function(e){o.viewPost.comments.sortBy(e),o.viewPost.commentIndex=e},this.commentVote=function(t){e.head("/comments/"+t.id+"/vote.json").success(function(){votedComments=o.viewPost.postRelation.voted_comments,commentIndex=votedComments.indexOf(t.id),-1==commentIndex?(t.karma+=1,votedComments.push(t.id)):(t.karma-=1,votedComments.splice(commentIndex,1))}).error(function(e,t){304==t&&alert("Vote could not be completed."),401==t&&o.signOut()})},this.showUserForm=function(){o.user={name:o.session.name,password:o.session.password},userForm.user_name.focus(),o.currentTab="signup"},this.signUp=function(){e.post("/users.json",o.user).success(function(e){o.currentUser=e,o.signedIn=!0,o.currentTab="index"}).error(function(e){o.user.errors=e.errors})},this.passwordCheck=function(){valid=o.user.password==o.user.password_confirmation,t.userForm.user_password_confirmation.$setValidity("passwordsMismatch",valid)},this.editUser=function(){o.user.about_me=o.viewUser.about_me,o.viewUser.editingAboutMe=!0},this.updateAboutMe=function(){e.put("/users/"+o.currentUser.id+".json",o.user).success(function(){o.viewUser.about_me=o.user.about_me,o.viewUser.editingAboutMe=!1}).error(function(e,t){304==t&&alert("Changes could not be saved."),401==t&&o.signOut()})},this.loadUser=function(t){return new Promise(function(n){o.viewUser.id&&o.viewUser.id==t?n(o.viewUser):e.get("/users/"+t+".json").success(function(e){o.viewUser=e,n(e)})})},this.showUser=function(e){"object"!=typeof e&&(e={userId:e}),o.hideMenu(),o.loadUser(e.userId).then(function(t){updateTitle(t.name),rootAddress=location.href.split("#")[0],e.preserveState||history.pushState({user:t},document.title,rootAddress+"#/users/"+t.id+"/"+t.name),o.setIndexControls("user").then(function(e){e.findOrFirst("action",o.indexView).then(function(e){o.loadIndexList(e),o.currentTab="user"})})})},this.showSessionForm=function(){o.currentTab="signin",o.session.name=sessionForm.session_name.value,o.session.password=sessionForm.session_password.value,sessionForm.session_name.focus(),t.$$phase||t.$apply()},this.signIn=function(){e.post("sessions.json",o.session).success(function(){o.currentUser={name:document.cookie.replace(/(.*)user_name=/,"").replace(/;(.*)/,""),id:document.cookie.replace(/(.*)user_id=/,"").replace(/;(.*)/,"")},o.session={},o.signedIn=!0,o.loadRoute()}).error(function(e,t){404==t&&(o.session.errors=["Name not found"]),401==t&&(o.session.errors=["Incorrect password"])})},this.signOut=function(){e.get("/signout.json").success(function(){}).error(function(){document.cookie="remember_token=; expires=Thu, 01 Jan 1970 00:00:01 GMT;",document.cookie="user_id=; expires=Thu, 01 Jan 1970 00:00:01 GMT;",document.cookie="user_name=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"}),o.currentUser={},o.clearout=!1,o.signedIn=!1,o.currentTab="signin"},this.timeAgo=function(e){return new Date(e).toRelativeTime(6e4)},window.addEventListener("popstate",function(){o.loadRoute(),t.$apply()},!1),this.loadCurrentUser=function(){"undefined"==typeof o.currentUser.id&&(o.currentUser={name:document.cookie.replace(/(.*)user_name=/,"").replace(/;(.*)/,""),id:document.cookie.replace(/(.*)user_id=/,"").replace(/;(.*)/,"")})},this.loadRoute=function(){o.clearout=!1,o.signedIn=-1!=document.cookie.indexOf("remember_token"),o.signedIn&&o.loadCurrentUser(),urlController=location.href.split("#/")[1],"undefined"!=typeof urlController?(urlController=urlController.split("/")[0],urlId=location.href.split("#/")[1].split("/")[1],urlId&&(urlId=urlId.split("/")[0]),"posts"==urlController?o.showPost(urlId):"users"==urlController?o.showUser({userId:urlId,preserveState:!0}):o.showIndex()):o.showIndex({preserveState:!0})},o.loadRoute()}]),app.directive("header",function(){return{restrict:"E",templateUrl:"header.html"}}),app.directive("users",function(){return{restrict:"E"}}),app.directive("userShow",function(){return{restrict:"E",templateUrl:"user-show.html"}}),app.directive("userSignin",function(){return{restrict:"E",templateUrl:"user-signin.html"}}),app.directive("userSignup",function(){return{restrict:"E",templateUrl:"user-signup.html"}}),app.directive("posts",function(){return{restrict:"E"}}),app.directive("postIndex",function(){return{restrict:"E",templateUrl:"post-index.html"}}),app.directive("postShow",function(){return{restrict:"E",templateUrl:"post-show.html"}}),app.directive("postForm",function(){return{restrict:"E",templateUrl:"post-form.html"}}),app.directive("comments",function(){return{restrict:"E"}}),app.directive("commentIndex",function(){return{restrict:"E",templateUrl:"comment-index.html"}}),app.directive("commentForm",function(){return{restrict:"E",templateUrl:"comment-form.html"}}),String.prototype.convertToSlug=function(){return text=this.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")},Array.prototype.sortBy=function(e){return"object"!=typeof this||"string"!=typeof e?!1:("undefined"!=typeof this[0][e]&&(array=this.sort(function(t,o){return t[e]<o[e]?1:t[e]>o[e]?-1:0})),array||(array=!1),array)},Array.prototype.findOrFirst=function(e,t){var o=this;return new Promise(function(n){if("undefined"!=typeof t)for(var s in o)"object"==typeof o[s]&&o[s][e]==t&&n(o[s]);n(o[0])})},Array.prototype.findIndex=function(e,t){for(var o in this)if(this[o][e]==t)return o;return!1},Date.prototype.toRelativeTime=function(){var e=function(e){var i=t(e),u=i.now||new Date,c=i.texts||r,d=u-this,a=0>=d;if(d=Math.abs(d),d<=i.nowThreshold)return a?c.right_now:c.just_now;if(i.smartDays&&6*s>=d)return o(this,u,c);var l=null;for(var p in n){if(d<n[p])break;l=p,d/=n[p]}return d=Math.floor(d),l=c.pluralize(d,l),[d,l,a?c.from_now:c.ago].join(" ")},t=function(e){return e||(e=0),"string"==typeof e&&(e=parseInt(e,10)),"number"==typeof e?(isNaN(e)&&(e=0),{nowThreshold:e}):e},o=function(e,t,o){var n,s=e.getDay(),i=s-t.getDay();return n=0==i?o.today:-1==i?o.yesterday:1==i&&e>t?o.tomorrow:o.days[s],n+" "+o.at+" "+e.toLocaleTimeString()},n={millisecond:1,second:1e3,minute:60,hour:60,day:24,month:30,year:12},s=n.millisecond*n.second*n.minute*n.hour*n.day,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],r={today:"Today",yesterday:"Yesterday",tomorrow:"Tomorrow",at:"at",from_now:"from now",ago:"ago",right_now:"Right now",just_now:"Just now",days:i,pluralize:function(e,t){return e>1?t+"s":t}};return e}(),Date.fromString=function(e){return new Date(Date.parse(e))};